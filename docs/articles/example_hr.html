<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Classification example - HR data • rSAFE</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../dalexverse.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../dalexverse-2.css" rel="stylesheet">
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Classification example - HR data">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- google analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-5650686-14"></script><script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-5650686-14');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">rSAFE</a>
        <div class="info">
          <span class="partof">part of the <a href="https://github.com/ModelOriented/DrWhy">DrWhy.AI</a>
           developed by the <a href="https://mi2.mini.pw.edu.pl/">MI^2 DataLab</a> </span>
          <span class="version version-default">0.1.0</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example_apartments.html">Regression example - apartments data</a>
    </li>
    <li>
      <a href="../articles/example_hr.html">Classification example - HR data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/ModelOriented/rSAFE">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Classification example - HR data</h1>
                        <h4 class="author">Anna Gierlak</h4>
            
            <h4 class="date">2019-10-04</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ModelOriented/rSAFE/blob/master/vignettes/example_hr.Rmd"><code>vignettes/example_hr.Rmd</code></a></small>
      <div class="hidden name"><code>example_hr.Rmd</code></div>

    </div>

    
    
<p>In this vignette we demonstrate an application of the <code>rSAFE</code> package to the <code>HR_data</code> set. The dataset contains information from a Human Resources department about employees and may be used in the classification task of predicting whether an employee is likely to leave the company. The data comes from the Kaggle competition “Human Resources Analytics” and is available in <code>breakDown</code> and <code>rSAFE</code> packages.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(rSAFE)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(HR_data)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co">#&gt;   satisfaction_level last_evaluation number_project average_montly_hours</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co">#&gt; 1               0.38            0.53              2                  157</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co">#&gt; 2               0.80            0.86              5                  262</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co">#&gt; 3               0.11            0.88              7                  272</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="co">#&gt; 4               0.72            0.87              5                  223</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="co">#&gt; 5               0.37            0.52              2                  159</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="co">#&gt; 6               0.41            0.50              2                  153</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co">#&gt;   time_spend_company Work_accident left promotion_last_5years sales salary</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="co">#&gt; 1                  3             0    1                     0 sales    low</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="co">#&gt; 2                  6             0    1                     0 sales medium</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="co">#&gt; 3                  4             0    1                     0 sales medium</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="co">#&gt; 4                  5             0    1                     0 sales    low</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="co">#&gt; 5                  3             0    1                     0 sales    low</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="co">#&gt; 6                  3             0    1                     0 sales    low</span></a></code></pre></div>
<p>As explanatory variables we use all available in the dataset except for  which specifies department in which the employee works for.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">data &lt;-<span class="st"> </span>HR_data[, <span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(HR_data) <span class="op">!=</span><span class="st"> "sales"</span>]</a></code></pre></div>
<p>In order to ensure the final errors are computed on the data which has not been seen by an approproate model, we divide our data as follows:</p>
<ul>
<li>
<code>data1</code> - the data which initial black-box and white-box models are fitted to,</li>
<li>
<code>data2</code> - the data used to create an <code>explainer</code> and a <code>safe_extractor</code> for black-box model from the previous point, serving also as a test data,</li>
<li>
<code>data3</code> - the data for which transformations and feature selection are performed, used also as a training set for new models,</li>
<li>
<code>data4</code> - the data used as a test set for the new models, allowing to compare the results. Before splitting the data, we first shuffle rows to ensure they are evenly distributed.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">111</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">data &lt;-<span class="st"> </span>data[<span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(data)),]</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">data1 &lt;-<span class="st"> </span>data[<span class="dv">1</span><span class="op">:</span><span class="dv">4000</span>,]</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">data2 &lt;-<span class="st"> </span>data[<span class="dv">4001</span><span class="op">:</span><span class="dv">8000</span>,]</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">data3 &lt;-<span class="st"> </span>data[<span class="dv">8001</span><span class="op">:</span><span class="dv">12000</span>,]</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">data4 &lt;-<span class="st"> </span>data[<span class="dv">12001</span><span class="op">:</span><span class="dv">14999</span>,]</a></code></pre></div>
<div id="building-a-black-box-model" class="section level2">
<h2 class="hasAnchor">
<a href="#building-a-black-box-model" class="anchor"></a>Building a black-box model</h2>
<p>In this example we decide to use the xgboost model as a black-box - it will serve us as a surrogate.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">n.trees &lt;-<span class="st"> </span><span class="dv">10000</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(gbm)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">111</span>)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">model_xgb1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/gbm/man/gbm.html">gbm</a></span>(left <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> data1, <span class="dt">distribution =</span> <span class="st">"bernoulli"</span>, <span class="dt">n.trees =</span> n.trees)</a></code></pre></div>
</div>
<div id="creating-an-explainer" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-an-explainer" class="anchor"></a>Creating an explainer</h2>
<p>We also create an <code>explainer</code> object that will be used later to create new variables. For classification problems we need to specify <code>predict_function</code> - a function that may be used for model predictions and returns a single numerical value for each observation.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(DALEX)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">predict_function &lt;-<span class="st"> </span><span class="cf">function</span>(model, x) <span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(model, x, <span class="dt">type =</span> <span class="st">"response"</span>, <span class="dt">n.trees =</span> n.trees)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">explainer_xgb1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/DALEX/man/explain.html">explain</a></span>(model_xgb1, <span class="dt">data =</span> data2[,<span class="op">-</span><span class="dv">7</span>], <span class="dt">y =</span> data2<span class="op">$</span>left, <span class="dt">predict_function =</span> predict_function, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
</div>
<div id="creating-a-safe_extractor" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-a-safe_extractor" class="anchor"></a>Creating a safe_extractor</h2>
<p>Now, we create a <code>safe_extractor</code> object using <code>rSAFE</code> package and our surrogate model. Setting the argument <code>verbose=FALSE</code> stops progress bar from printing.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">safe_extractor &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/rSAFE/man/safe_extraction.html">safe_extraction</a></span>(explainer_xgb1, <span class="dt">penalty =</span> <span class="dv">20</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p>Now, let’s print summary for the new object we have just created.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(safe_extractor)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&gt; Variable 'satisfaction_level' - selected intervals:</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">#&gt;  (-Inf, 0.45]</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co">#&gt;      (0.45, 0.91]</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co">#&gt;      (0.91, Inf)</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">#&gt; Variable 'last_evaluation' - selected intervals:</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&gt;  (-Inf, 0.42]</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="co">#&gt;      (0.42, 0.57]</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co">#&gt;      (0.57, 0.8]</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="co">#&gt;      (0.8, Inf)</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="co">#&gt; Variable 'number_project' - selected intervals:</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="co">#&gt;  (-Inf, 4]</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="co">#&gt;      (4, Inf)</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14"><span class="co">#&gt; Variable 'average_montly_hours' - selected intervals:</span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="co">#&gt;  (-Inf, 211]</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="co">#&gt;      (211, Inf)</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="co">#&gt; Variable 'time_spend_company' - selected intervals:</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"><span class="co">#&gt;  (-Inf, 3]</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="co">#&gt;      (3, Inf)</span></a>
<a class="sourceLine" id="cb7-20" data-line-number="20"><span class="co">#&gt; Variable 'Work_accident' - no transformation suggested.</span></a>
<a class="sourceLine" id="cb7-21" data-line-number="21"><span class="co">#&gt; Variable 'promotion_last_5years' - no transformation suggested.</span></a>
<a class="sourceLine" id="cb7-22" data-line-number="22"><span class="co">#&gt; Variable 'salary' - created levels:</span></a>
<a class="sourceLine" id="cb7-23" data-line-number="23"><span class="co">#&gt;  high -&gt;  high </span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24"><span class="co">#&gt;  low, medium -&gt;  low_medium</span></a></code></pre></div>
<p>We can see transormation propositions for all variables in our dataset.</p>
<p>In the plot below we can see which points have been chosen to be the breakpoints for a particular variable:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(safe_extractor, <span class="dt">variable =</span> <span class="st">"last_evaluation"</span>)</a></code></pre></div>
<p><img src="example_hr_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<p>For factor variables we can observe in which order levels have been merged and what is the optimal clustering:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(safe_extractor, <span class="dt">variable =</span> <span class="st">"salary"</span>)</a></code></pre></div>
<p><img src="example_hr_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
</div>
<div id="transforming-data" class="section level2">
<h2 class="hasAnchor">
<a href="#transforming-data" class="anchor"></a>Transforming data</h2>
<p>Now we can use our <code>safe_extractor</code> object to create new categorical features in the given dataset.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">data3_trans &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/rSAFE/man/safely_transform_data.html">safely_transform_data</a></span>(safe_extractor, data3, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">salary</th>
<th align="right">satisfaction_level</th>
<th align="right">last_evaluation</th>
<th align="right">number_project</th>
<th align="right">average_montly_hours</th>
<th align="right">time_spend_company</th>
<th align="right">Work_accident</th>
<th align="right">left</th>
<th align="right">promotion_last_5years</th>
<th align="left">satisfaction_level_new</th>
<th align="left">last_evaluation_new</th>
<th align="left">number_project_new</th>
<th align="left">average_montly_hours_new</th>
<th align="left">time_spend_company_new</th>
<th align="left">salary_new</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">low</td>
<td align="right">0.85</td>
<td align="right">0.82</td>
<td align="right">3</td>
<td align="right">153</td>
<td align="right">3</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">(0.45, 0.91]</td>
<td align="left">(0.8, Inf)</td>
<td align="left">(-Inf, 4]</td>
<td align="left">(-Inf, 211]</td>
<td align="left">(-Inf, 3]</td>
<td align="left">low_medium</td>
</tr>
<tr class="even">
<td align="left">low</td>
<td align="right">0.10</td>
<td align="right">0.91</td>
<td align="right">6</td>
<td align="right">262</td>
<td align="right">5</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left">(-Inf, 0.45]</td>
<td align="left">(0.8, Inf)</td>
<td align="left">(4, Inf)</td>
<td align="left">(211, Inf)</td>
<td align="left">(3, Inf)</td>
<td align="left">low_medium</td>
</tr>
<tr class="odd">
<td align="left">medium</td>
<td align="right">0.46</td>
<td align="right">0.66</td>
<td align="right">6</td>
<td align="right">229</td>
<td align="right">3</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">(0.45, 0.91]</td>
<td align="left">(0.57, 0.8]</td>
<td align="left">(4, Inf)</td>
<td align="left">(211, Inf)</td>
<td align="left">(-Inf, 3]</td>
<td align="left">low_medium</td>
</tr>
<tr class="even">
<td align="left">high</td>
<td align="right">0.86</td>
<td align="right">0.61</td>
<td align="right">4</td>
<td align="right">193</td>
<td align="right">2</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">(0.45, 0.91]</td>
<td align="left">(0.57, 0.8]</td>
<td align="left">(-Inf, 4]</td>
<td align="left">(-Inf, 211]</td>
<td align="left">(-Inf, 3]</td>
<td align="left">high</td>
</tr>
<tr class="odd">
<td align="left">medium</td>
<td align="right">0.92</td>
<td align="right">0.60</td>
<td align="right">3</td>
<td align="right">198</td>
<td align="right">2</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">(0.91, Inf)</td>
<td align="left">(0.57, 0.8]</td>
<td align="left">(-Inf, 4]</td>
<td align="left">(-Inf, 211]</td>
<td align="left">(-Inf, 3]</td>
<td align="left">low_medium</td>
</tr>
<tr class="even">
<td align="left">medium</td>
<td align="right">0.73</td>
<td align="right">0.51</td>
<td align="right">3</td>
<td align="right">244</td>
<td align="right">2</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">(0.45, 0.91]</td>
<td align="left">(0.42, 0.57]</td>
<td align="left">(-Inf, 4]</td>
<td align="left">(211, Inf)</td>
<td align="left">(-Inf, 3]</td>
<td align="left">low_medium</td>
</tr>
</tbody>
</table>
<p>We can also perform feature selection if we wish. For each original feature it keeps exactly one of their forms - original one or transformed one.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">selected_variables &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/rSAFE/man/safely_select_variables.html">safely_select_variables</a></span>(safe_extractor, data3_trans, <span class="dt">which_y =</span> <span class="st">"left"</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">data3_trans_sel &lt;-<span class="st"> </span>data3_trans[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"left"</span>, selected_variables)]</a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(selected_variables)</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="co">#&gt; [1] "Work_accident"            "promotion_last_5years"   </span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="co">#&gt; [3] "salary"                   "satisfaction_level_new"  </span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="co">#&gt; [5] "last_evaluation_new"      "number_project_new"      </span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co">#&gt; [7] "average_montly_hours_new" "time_spend_company_new"</span></a></code></pre></div>
<p>It can be observed that for some features the original form was preffered and for others the transformed one.</p>
<p>Here are the first few rows for our data after feature selection:</p>
<table class="table">
<thead><tr class="header">
<th align="right">left</th>
<th align="right">Work_accident</th>
<th align="right">promotion_last_5years</th>
<th align="left">salary</th>
<th align="left">satisfaction_level_new</th>
<th align="left">last_evaluation_new</th>
<th align="left">number_project_new</th>
<th align="left">average_montly_hours_new</th>
<th align="left">time_spend_company_new</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left">low</td>
<td align="left">(0.45, 0.91]</td>
<td align="left">(0.8, Inf)</td>
<td align="left">(-Inf, 4]</td>
<td align="left">(-Inf, 211]</td>
<td align="left">(-Inf, 3]</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left">low</td>
<td align="left">(-Inf, 0.45]</td>
<td align="left">(0.8, Inf)</td>
<td align="left">(4, Inf)</td>
<td align="left">(211, Inf)</td>
<td align="left">(3, Inf)</td>
</tr>
<tr class="odd">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">medium</td>
<td align="left">(0.45, 0.91]</td>
<td align="left">(0.57, 0.8]</td>
<td align="left">(4, Inf)</td>
<td align="left">(211, Inf)</td>
<td align="left">(-Inf, 3]</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">high</td>
<td align="left">(0.45, 0.91]</td>
<td align="left">(0.57, 0.8]</td>
<td align="left">(-Inf, 4]</td>
<td align="left">(-Inf, 211]</td>
<td align="left">(-Inf, 3]</td>
</tr>
<tr class="odd">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">medium</td>
<td align="left">(0.91, Inf)</td>
<td align="left">(0.57, 0.8]</td>
<td align="left">(-Inf, 4]</td>
<td align="left">(-Inf, 211]</td>
<td align="left">(-Inf, 3]</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">medium</td>
<td align="left">(0.45, 0.91]</td>
<td align="left">(0.42, 0.57]</td>
<td align="left">(-Inf, 4]</td>
<td align="left">(211, Inf)</td>
<td align="left">(-Inf, 3]</td>
</tr>
</tbody>
</table>
<p>Now, we perform transformations on another data that will be used later to compare models performance.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">data4_trans &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/rSAFE/man/safely_transform_data.html">safely_transform_data</a></span>(safe_extractor, data4, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">data4_trans_sel &lt;-<span class="st"> </span>data4_trans[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"left"</span>, selected_variables)]</a></code></pre></div>
</div>
<div id="creating-white-box-models-on-original-and-transformed-datasets" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-white-box-models-on-original-and-transformed-datasets" class="anchor"></a>Creating white-box models on original and transformed datasets</h2>
<p>Let’s fit the models to data containg newly created columns. We consider a generalized linear model (glm) as a white-box model.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">model_lr2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(left <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> data3_trans_sel, <span class="dt">family =</span> <span class="kw"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span>())</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">111</span>)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">model_xgb2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/gbm/man/gbm.html">gbm</a></span>(left <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> data3_trans_sel, <span class="dt">distribution =</span> <span class="st">"bernoulli"</span>, <span class="dt">n.trees =</span> n.trees)</a></code></pre></div>
<p>Moreover, we create a glm model based on original data in order to check if our methodology improves results.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">model_lr1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(left <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> data1, <span class="dt">family =</span> <span class="kw"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span>())</a></code></pre></div>
</div>
<div id="comparing-models-performance" class="section level2">
<h2 class="hasAnchor">
<a href="#comparing-models-performance" class="anchor"></a>Comparing models performance</h2>
<p>Final step is the comparison of all four models we have created. For each of them we make predictions on the relevant test set, i.e. we use <code>model_lr1</code> and <code>model_xgb1</code> to predict the output for <code>data2</code> and <code>model_lr2</code> and <code>model_xgb2</code> to predict the output for <code>data4</code>.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">pred_lr1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(model_lr1, data2, <span class="dt">type =</span> <span class="st">"response"</span>))</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">pred_xgb1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(model_xgb1, data2, <span class="dt">n.trees =</span> n.trees, <span class="dt">type =</span> <span class="st">"response"</span>))</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">pred_lr2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(model_lr2, data4_trans_sel, <span class="dt">type =</span> <span class="st">"response"</span>))</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">pred_xgb2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(model_xgb2, data4_trans_sel, <span class="dt">n.trees =</span> n.trees, <span class="dt">type =</span> <span class="st">"response"</span>))</a></code></pre></div>
<p>The performance of the models may then be evaluated based on confusion matrices with relative percentages obtained via the <code>confusion_matrix</code> function:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">confusion_matrix &lt;-<span class="st"> </span><span class="cf">function</span>(y_true, y_pred) {</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">  cm &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">pred_0 =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(y_true<span class="op">==</span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>y_pred<span class="op">==</span><span class="dv">0</span>)<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(y_true<span class="op">==</span><span class="dv">0</span>),</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">                              <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(y_true<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>y_pred<span class="op">==</span><span class="dv">0</span>)<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(y_true<span class="op">==</span><span class="dv">1</span>)),</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">                   <span class="dt">pred_1 =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(y_true<span class="op">==</span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>y_pred<span class="op">==</span><span class="dv">1</span>)<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(y_true<span class="op">==</span><span class="dv">0</span>),</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">                              <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(y_true<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>y_pred<span class="op">==</span><span class="dv">1</span>)<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(y_true<span class="op">==</span><span class="dv">1</span>)))</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">  cm &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(cm, <span class="dt">MARGIN =</span> <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(x, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">  <span class="kw"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(cm) &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"actual_0"</span>, <span class="st">"actual_1"</span>)</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">  cm</a>
<a class="sourceLine" id="cb16-9" data-line-number="9">}</a></code></pre></div>
<p>Xgboost models give the following results:</p>
<ul>
<li>for the original data:</li>
</ul>
<table class="table">
<colgroup>
<col width="20%">
<col width="25%">
<col width="25%">
</colgroup>
<thead><tr class="header">
<th align="center"> </th>
<th align="center"><strong>predicted 0</strong></th>
<th align="center"><strong>predicted 1</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center"><strong>actual 0</strong></td>
<td align="center">0.97</td>
<td align="center">0.03</td>
</tr>
<tr class="even">
<td align="center"><strong>actual 1</strong></td>
<td align="center">0.09</td>
<td align="center">0.91</td>
</tr>
</tbody>
</table>
<ul>
<li>for the data with <code>rSAFE</code> transformations applied:</li>
</ul>
<table class="table">
<colgroup>
<col width="20%">
<col width="25%">
<col width="25%">
</colgroup>
<thead><tr class="header">
<th align="center"> </th>
<th align="center"><strong>predicted 0</strong></th>
<th align="center"><strong>predicted 1</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center"><strong>actual 0</strong></td>
<td align="center">0.93</td>
<td align="center">0.07</td>
</tr>
<tr class="even">
<td align="center"><strong>actual 1</strong></td>
<td align="center">0.27</td>
<td align="center">0.73</td>
</tr>
</tbody>
</table>
<p>The model trained on original data has higher predictive power - feature transformations have caused the loss of valuable information which was apparently used by the first model. However, within logistic regression models the significant improvement can be observed:</p>
<ul>
<li>for the original data:</li>
</ul>
<table class="table">
<colgroup>
<col width="20%">
<col width="25%">
<col width="25%">
</colgroup>
<thead><tr class="header">
<th align="center"> </th>
<th align="center"><strong>predicted 0</strong></th>
<th align="center"><strong>predicted 1</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center"><strong>actual 0</strong></td>
<td align="center">0.92</td>
<td align="center">0.08</td>
</tr>
<tr class="even">
<td align="center"><strong>actual 1</strong></td>
<td align="center">0.63</td>
<td align="center">0.37</td>
</tr>
</tbody>
</table>
<ul>
<li>for the data with <code>rSAFE</code> transformations applied:</li>
</ul>
<table class="table">
<colgroup>
<col width="20%">
<col width="25%">
<col width="25%">
</colgroup>
<thead><tr class="header">
<th align="center"> </th>
<th align="center"><strong>predicted 0</strong></th>
<th align="center"><strong>predicted 1</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center"><strong>actual 0</strong></td>
<td align="center">0.93</td>
<td align="center">0.07</td>
</tr>
<tr class="even">
<td align="center"><strong>actual 1</strong></td>
<td align="center">0.27</td>
<td align="center">0.73</td>
</tr>
</tbody>
</table>
<p>The initial logistic regression model has difficulties with “true negatives” - for employees that actually quit it very often predicts the opposite. On the other hand, <code>model_lr2</code> which was trained on the set of features modified by the SAFE algorithm has much better accuracy.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#building-a-black-box-model">Building a black-box model</a></li>
      <li><a href="#creating-an-explainer">Creating an explainer</a></li>
      <li><a href="#creating-a-safe_extractor">Creating a safe_extractor</a></li>
      <li><a href="#transforming-data">Transforming data</a></li>
      <li><a href="#creating-white-box-models-on-original-and-transformed-datasets">Creating white-box models on original and transformed datasets</a></li>
      <li><a href="#comparing-models-performance">Comparing models performance</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="author">
  <p>
    Developed by Anna Gierlak, Przemyslaw Biecek.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>

      </footer>
</div>

  


  </body>
</html>
